# Booking.vue

## Описание

Компонент `Booking.vue` представляет собой форму поиска номеров в системе бронирования. Компонент позволяет пользователям выбрать даты заезда/выезда, указать количество гостей и ввести промокод для поиска доступных номеров.

## Расположение

```
app/components/booking/Booking.vue
```

## Зависимости

### Stores

- **`useBookingStore`** (`~/stores/booking`) - хранилище состояния бронирования
  - Используемые свойства:
    - `date` - выбранные даты заезда/выезда (`[Date, Date] | null`)
    - `guests` - информация о гостях (количество комнат и список комнат с количеством взрослых и детей)
    - `promoCode` - промокод для скидки
    - `loading` - состояние загрузки
  - Используемые методы:
    - `setLoading(visible: boolean, message?: string)` - установка состояния загрузки
    - `search(skipReset: boolean)` - выполнение поиска номеров

### Composables

- **`useToast()`** - для отображения уведомлений пользователю
- **`useRouter()`** - для программной навигации
- **`useRoute()`** - для получения текущего маршрута
- **`storeToRefs()`** - для создания реактивных ссылок на свойства store

### Компоненты

- **`CoreDatePicker`** - компонент выбора дат заезда/выезда
- **`CoreGuestsSelector`** - компонент выбора количества гостей и комнат
- **`CorePromoCodeInput`** - компонент ввода промокода
- **`UButton`** - кнопка из UI библиотеки Nuxt UI

### Типы

- **`ApiError`** (`~/composables/useApi`) - интерфейс ошибки API
  ```typescript
  interface ApiError {
    message: string;
    status?: number;
    statusText?: string;
    data?: unknown;
  }
  ```

### Утилиты

- **`getRequestErrorContent`** (`~/components/common/RequestErrorMessage.vue`) - функция для получения содержимого сообщения об ошибке

## Структура компонента

### Script Setup

Компонент использует Composition API с `<script setup>`.

#### Реактивные данные

Все данные берутся из `bookingStore` через `storeToRefs`:

- `date` - даты заезда/выезда
- `guests` - информация о гостях
- `promoCode` - промокод
- `loading` - состояние загрузки

#### Методы

##### `validateForm(): boolean`

Валидирует форму перед отправкой запроса на поиск.

**Проверки:**

1. Наличие выбранных дат (`date.value`)
2. Наличие хотя бы одного взрослого гостя (сумма `adults` из всех комнат в `roomList`)

**Возвращает:**

- `true` - если форма валидна
- `false` - если форма невалидна (при этом показывается toast-уведомление)

**Toast-уведомления:**

- При отсутствии дат: "Некорректные данные" / "Пожалуйста, выберите даты"
- При отсутствии взрослых: "Некорректные данные" / "Пожалуйста, укажите количество взрослых"

##### `handleSearch(): Promise<void>`

Асинхронный метод обработки поиска номеров.

**Алгоритм работы:**

1. **Валидация формы** - вызывает `validateForm()`, при неудаче прерывает выполнение
2. **Установка состояния загрузки** - устанавливает `loading = true` с сообщением "Загружаем данные о номерах..."
3. **Выполнение поиска** - вызывает `bookingStore.search(true)`
4. **Определение целевого маршрута:**
   - Если количество комнат > 1 → `/multi-rooms`
   - Иначе → `/rooms`
5. **Навигация** - переходит на целевой маршрут, если текущий путь отличается
6. **Обработка ошибок:**
   - При ошибке извлекает `status` и `message` из `ApiError`
   - Получает `summary` и `detail` через `getRequestErrorContent()`
   - Показывает toast-уведомление с предупреждением
7. **Сброс состояния** - устанавливает `loading = false` и `isServerRequest = false`
8. **Логирование (DEV режим)** - в режиме разработки выводит в консоль данные поиска

**Обработка ошибок:**

```typescript
catch (error: unknown) {
  const { status, message } = (error || {}) as ApiError;
  const { summary, detail } = getRequestErrorContent(status, message);

  toast.add({
    severity: "warn",
    summary,
    detail,
    life: 3000,
  });
  // ...
}
```

### Template

Компонент рендерит форму поиска с следующими элементами:

```vue
<section :class="$style.wrapper">
  <div :class="$style.form">
    <CoreDatePicker v-model="date" />
    <CoreGuestsSelector v-model="guests" />
    <CorePromoCodeInput v-model="promoCode" />
    
    <UButton
      :class="$style.button"
      color="bgAccent"
      class="text-white px-4 py-2"
      size="xl"
      :loading="loading"
      :disabled="loading"
      @click="handleSearch"
    >
      {{ loading ? "Поиск..." : "Поиск" }}
    </UButton>
  </div>
</section>
```

**Структура:**

- `section.wrapper` - обертка формы
- `div.form` - контейнер формы с flexbox-раскладкой
- `CoreDatePicker` - выбор дат (двусторонняя привязка к `date`)
- `CoreGuestsSelector` - выбор гостей (двусторонняя привязка к `guests`)
- `CorePromoCodeInput` - ввод промокода (двусторонняя привязка к `promoCode`)
- `UButton` - кнопка поиска с состоянием загрузки

**Примечание:** Компонент использует CSS Modules (`<style module>`) с SCSS. Подробнее о системе стилей проекта см. в [общей документации](../README.md#стили).

## Использование

### Базовое использование

Компонент не требует props и автоматически использует данные из `bookingStore`:

```vue
<template>
  <Booking />
</template>
```

### Интеграция с маршрутизацией

Компонент автоматически перенаправляет пользователя на соответствующий маршрут после успешного поиска:

- `/rooms` - для одного номера
- `/multi-rooms` - для нескольких номеров

## Состояния компонента

### Состояние загрузки

Компонент отображает состояние загрузки через:

- Свойство `loading` из store
- Текст кнопки меняется на "Поиск..." при загрузке
- Кнопка становится неактивной (`disabled`) во время загрузки

### Обработка ошибок

При ошибке поиска:

1. Показывается toast-уведомление с деталями ошибки
2. Состояние загрузки сбрасывается
3. Пользователь остается на текущей странице

## Валидация

Компонент выполняет валидацию перед отправкой запроса:

1. **Проверка дат:** Обязательно наличие выбранных дат заезда/выезда
2. **Проверка гостей:** Обязательно наличие хотя бы одного взрослого гостя

При невалидных данных показываются соответствующие toast-уведомления, и поиск не выполняется.

## Логирование

В режиме разработки (`import.meta.env.DEV`) компонент логирует данные поиска в консоль:

```javascript
console.log("Поиск:", {
  date: date.value,
  guests: guests.value,
  promoCode: promoCode.value,
});
```

## Зависимости от других компонентов

### CoreDatePicker

Компонент выбора диапазона дат. Ожидает `v-model` с типом `[Date, Date] | null`.

### CoreGuestsSelector

Компонент выбора количества гостей и комнат. Ожидает `v-model` с типом:

```typescript
{
  rooms: number;
  roomList: { adults: number; children: number; childrenAges: number[] }[];
}
```

### CorePromoCodeInput

Компонент ввода промокода. Ожидает `v-model` с типом `string`.

## Примеры использования

### Полный пример страницы

```vue
<script setup lang="ts">
// Страница использует компонент Booking
</script>

<template>
  <div>
    <h1>Поиск номеров</h1>
    <Booking />
  </div>
</template>
```

## Примечания

- Компонент использует глобальное состояние через Pinia store
- Все данные формы синхронизируются с `bookingStore`
- Состояние бронирования сохраняется в localStorage через плагин персистентности Pinia
- Компонент автоматически определяет, на какую страницу перенаправить пользователя в зависимости от количества выбранных комнат

## Связанные компоненты

- `CoreDatePicker` - выбор дат
- `CoreGuestsSelector` - выбор гостей
- `CorePromoCodeInput` - ввод промокода
- `RequestErrorMessage` - обработка ошибок API

## Связанные страницы

- `/rooms` - страница результатов поиска для одного номера
- `/multi-rooms` - страница результатов поиска для нескольких номеров
