# GuestsSelector.vue

## Описание

Компонент `GuestsSelector.vue` представляет собой комплексный селектор для выбора количества номеров, взрослых и детей с указанием возраста детей в системе бронирования. Компонент поддерживает работу с несколькими номерами (до 5), автоматическую нормализацию данных и обратную совместимость с legacy форматом данных.

## Расположение

```
app/components/core/GuestsSelector.vue
```

## Зависимости

### Props

- **`modelValue`** (`GuestsValue | LegacyGuestsValue`) - значение компонента в формате v-model
  - **Тип**: `GuestsValue | { rooms: number; adults: number; children: number }`
  - **Обязательный**: Нет
  - **Описание**: Может быть передано в новом формате (`GuestsValue`) или в legacy формате для обратной совместимости

### Stores

Компонент не использует stores напрямую, но может работать с данными из `useBookingStore` через v-model.

### Composables

Компонент не использует composables напрямую.

### Компоненты

- **`Popover`** (PrimeVue) - компонент выпадающего меню для отображения формы выбора гостей
- **`CoreCounter`** - компонент счетчика для изменения числовых значений (количество номеров, взрослых, детей)
- **`CoreRoomBlock`** - компонент блока номера для отображения и редактирования данных по каждому номеру
- **`Button`** (PrimeVue) - кнопка применения изменений ("Готово")
- **`UIcon`** - компонент иконок из Nuxt UI (иконка шеврона для открытия меню)

### Типы

- **`RoomGuests`** (`~/components/core/GuestsSelector.vue`) - интерфейс данных о гостях в одном номере
  ```typescript
  export interface RoomGuests {
    adults: number;        // Количество взрослых (минимум 1)
    children: number;      // Количество детей (минимум 0)
    childrenAges: number[]; // Массив возрастов детей (0-12 лет)
  }
  ```

- **`GuestsValue`** - интерфейс для нового формата данных
  ```typescript
  interface GuestsValue {
    rooms: number;              // Количество номеров (1-5)
    roomList: RoomGuests[];     // Массив данных по каждому номеру
  }
  ```

- **`LegacyGuestsValue`** - интерфейс для старого формата данных (поддерживается для обратной совместимости)
  ```typescript
  interface LegacyGuestsValue {
    rooms: number;    // Количество номеров
    adults: number;   // Количество взрослых (применяется к первому номеру)
    children: number; // Количество детей (применяется к первому номеру)
  }
  ```

### Утилиты

- **`AGE_MIN`, `AGE_MAX`** (`~/utils/age`) - константы минимального и максимального возраста детей (0-12 лет)
- **`declension`** (`~/utils/declension`) - функция склонения слов для русского языка (для формирования summaryString)

## Структура компонента

### Script Setup

Компонент использует Composition API с `<script setup>`.

#### Константы

- `MAX_ROOMS = 5` - максимальное количество номеров

#### Реактивные данные

- `guests` - computed свойство для двусторонней привязки данных через v-model
- `overlayRef` - ссылка на компонент Popover для управления открытием/закрытием меню

#### Computed свойства

##### `guests: GuestsValue`

Computed свойство для работы с данными в формате v-model.

**Алгоритм работы getter:**

1. **Если `modelValue` не передан или некорректен**: возвращает значения по умолчанию
   ```typescript
   {
     rooms: 1,
     roomList: [{ adults: 1, children: 0, childrenAges: [] }]
   }
   ```

2. **Если передан новый формат** (с `roomList`):
   - Нормализует массив `childrenAges` для каждого номера:
     - Если количество возрастов меньше количества детей, недостающие заполняются `AGE_MIN`
     - Если количество возрастов больше количества детей, лишние обрезаются
     - Если `childrenAges` отсутствует, создается массив с `AGE_MIN` для каждого ребенка

3. **Если передан legacy формат**:
   - Значения `adults` и `children` применяются к первому номеру
   - Остальные номера инициализируются с дефолтными значениями (1 взрослый, 0 детей)
   - Для первого номера создается массив `childrenAges` с `AGE_MIN` для каждого ребенка

**Setter:** Эмитит событие `update:modelValue` с новым значением.

##### `summaryString: string`

Формирует строку-сводку о выбранных гостях.

**Формат:** `"{количество} {номер/номера/номеров}, {всего взрослых} взр., {всего детей} дет."`

**Примеры:**
- `"1 номер, 2 взр., 1 дет."`
- `"3 номера, 5 взр., 3 дет."`
- `"2 номера, 3 взр., 0 дет."`

**Алгоритм:**
- Суммирует количество взрослых из всех номеров
- Суммирует количество детей из всех номеров
- Использует функцию `declension()` для правильного склонения слова "номер"

#### Методы

##### `openOverlay(event: Event): void`

Открывает выпадающее меню выбора гостей.

**Параметры:**
- `event` - событие клика

**Действия:**
- Вызывает метод `toggle()` компонента Popover через `overlayRef`

##### `updateRooms(value: number): void`

Обновляет количество номеров.

**Параметры:**
- `value` - новое количество номеров

**Алгоритм:**
1. Ограничивает значение диапазоном от 1 до `MAX_ROOMS` (5)
2. Если значение не изменилось, прерывает выполнение
3. Обрезает или дополняет массив `roomList`:
   - При уменьшении: удаляет последние номера
   - При увеличении: добавляет номера с дефолтными значениями (1 взрослый, 0 детей)
4. Обновляет `guests.value` с новым количеством номеров

##### `deleteRoom(roomIdx: number): void`

Удаляет номер по индексу.

**Параметры:**
- `roomIdx` - индекс номера для удаления

**Ограничения:**
- Нельзя удалить номер, если остался только один (`guests.value.rooms <= 1`)

**Алгоритм:**
1. Проверяет, что количество номеров больше 1
2. Фильтрует массив `roomList`, удаляя номер с указанным индексом
3. Уменьшает количество номеров на 1
4. Обновляет `guests.value`

##### `updateRoomAdults(roomIdx: number, value: number): void`

Обновляет количество взрослых в указанном номере.

**Параметры:**
- `roomIdx` - индекс номера
- `value` - новое количество взрослых

**Валидация:**
- Минимум 1 взрослый в каждом номере (`Math.max(1, value)`)

**Алгоритм:**
1. Находит номер по индексу
2. Обновляет количество взрослых с учетом минимума
3. Обновляет `guests.value`

##### `updateRoomChildren(roomIdx: number, value: number): void`

Обновляет количество детей в указанном номере.

**Параметры:**
- `roomIdx` - индекс номера
- `value` - новое количество детей

**Валидация:**
- Минимум 0 детей в каждом номере (`Math.max(0, value)`)

**Алгоритм:**
1. Находит номер по индексу
2. Обновляет количество детей с учетом минимума
3. Автоматически обновляет массив `childrenAges`:
   - При увеличении: сохраняет существующие возрасты, добавляет новые со значением `AGE_MIN`
   - При уменьшении: обрезает массив, сохраняя первые возрасты
4. Обновляет `guests.value`

##### `updateChildAge(roomIdx: number, childIdx: number, age: number): void`

Обновляет возраст конкретного ребенка.

**Параметры:**
- `roomIdx` - индекс номера
- `childIdx` - индекс ребенка в массиве `childrenAges`
- `age` - новый возраст

**Валидация:**
- Возраст автоматически ограничивается диапазоном `AGE_MIN` (0) - `AGE_MAX` (12) лет
- Используется `Math.min(AGE_MAX, Math.max(AGE_MIN, Number(age)))`

**Алгоритм:**
1. Находит номер по индексу
2. Создает копию массива `childrenAges`
3. Обновляет возраст ребенка с учетом валидации
4. Обновляет `guests.value`

##### `applyChanges(event: Event): void`

Применяет изменения и закрывает выпадающее меню.

**Параметры:**
- `event` - событие клика на кнопку "Готово"

**Алгоритм:**
1. Эмитит событие `update:modelValue` с текущими данными `guests.value`
2. Закрывает Popover через метод `hide()`

### Template

Компонент рендерит форму выбора гостей со следующей структурой:

```vue
<div :class="$style.guestSection">
  <!-- Поле ввода с summaryString -->
  <div :class="$style.inputWrapper" @click="openOverlay">
    <input
      readonly
      :class="$style.customInput"
      :aria-label="`Гости: ${summaryString}`"
      :value="summaryString"
    >
    <span :class="$style.label">Гости</span>
    <UIcon name="i-chevron-down" :class="$style.chevronIcon" />
  </div>

  <!-- Выпадающее меню -->
  <Popover ref="overlayRef" class="guests-dropdown">
    <div :class="$style.guestsDropdownContent">
      <!-- Счетчик количества номеров -->
      <div :class="$style.guestOption">
        <span :class="$style.roomsTitle">Номера</span>
        <CoreCounter
          :model-value="guests.rooms"
          :min="1"
          :max="MAX_ROOMS"
          @update:model-value="updateRooms"
        />
      </div>

      <!-- Блоки номеров -->
      <CoreRoomBlock
        v-for="(room, idx) in guests.roomList"
        :key="`room-${idx}-${guests.rooms}`"
        :room="room"
        :room-index="idx"
        :total-rooms="guests.rooms"
        @update:adults="(val) => updateRoomAdults(idx, val)"
        @update:children="(val) => updateRoomChildren(idx, val)"
        @update:child-age="(childIdx, age) => updateChildAge(idx, childIdx, age)"
        @delete="deleteRoom(idx)"
      />

      <!-- Кнопка применения -->
      <Button
        class="btn__bs"
        :class="$style.applyButton"
        unstyled
        @click="applyChanges"
      >
        Готово
      </Button>
    </div>
  </Popover>
</div>
```

**Структура:**

- `div.guestSection` - основной контейнер компонента
- `div.inputWrapper` - обертка для поля ввода (кликабельная область)
- `input.customInput` - readonly поле с summaryString
- `span.label` - метка "Гости"
- `UIcon` - иконка шеврона для индикации выпадающего меню
- `Popover` - выпадающее меню (PrimeVue)
- `div.guestsDropdownContent` - содержимое меню
- `div.guestOption` - блок с выбором количества номеров
- `CoreCounter` - счетчик для количества номеров
- `CoreRoomBlock` - блоки для каждого номера (рендерятся в цикле)
- `Button` - кнопка "Готово" для применения изменений

**Отображаемая информация:**

1. **Поле ввода:** Строка-сводка в формате "X номер/номера/номеров, Y взр., Z дет."
2. **Выпадающее меню:**
   - Счетчик количества номеров (1-5)
   - Для каждого номера:
     - Заголовок номера (если номеров больше 1, показывается "Номер X")
     - Кнопка удаления номера (если номеров больше 1)
     - Счетчик количества взрослых (минимум 1)
     - Счетчик количества детей (минимум 0)
     - Селекторы возраста для каждого ребенка (если есть дети)
   - Кнопка "Готово" для применения изменений

**Интерактивные элементы:**

- Поле ввода - открывает выпадающее меню при клике
- Счетчик номеров - изменяет количество номеров
- Кнопка удаления номера - удаляет номер (если номеров > 1)
- Счетчики взрослых/детей - изменяют количество гостей в номере
- Селекторы возраста - изменяют возраст конкретного ребенка
- Кнопка "Готово" - применяет изменения и закрывает меню

**Примечание:** Компонент использует CSS Modules (`<style module>`) с SCSS. Подробнее о системе стилей проекта см. в [общей документации](../README.md#стили).

## Использование

### Базовое использование

Компонент использует v-model для двусторонней привязки данных:

```vue
<template>
  <CoreGuestsSelector v-model="guests" />
</template>

<script setup lang="ts">
import type { RoomGuests } from '~/components/core/GuestsSelector.vue';

const guests = ref({
  rooms: 1,
  roomList: [
    { adults: 2, children: 1, childrenAges: [5] }
  ]
});
</script>
```

### Использование с legacy форматом

Компонент поддерживает обратную совместимость со старым форматом данных:

```vue
<template>
  <CoreGuestsSelector v-model="legacyGuests" />
</template>

<script setup lang="ts">
const legacyGuests = ref({
  rooms: 2,
  adults: 3,
  children: 2
});
</script>
```

**Важно:** При использовании legacy формата компонент автоматически конвертирует данные в новый формат. Значения `adults` и `children` применяются к первому номеру, остальные номера инициализируются с дефолтными значениями.

### Интеграция с Pinia store

Компонент может работать с данными из `bookingStore`:

```vue
<template>
  <CoreGuestsSelector v-model="bookingStore.guests" />
</template>

<script setup lang="ts">
import { useBookingStore } from '~/stores/booking';

const bookingStore = useBookingStore();
</script>
```

## Состояния компонента

### Состояние выпадающего меню

Выпадающее меню управляется через компонент `Popover` (PrimeVue):

- **Открыто:** При клике на поле ввода вызывается `openOverlay()`, который открывает меню
- **Закрыто:** По умолчанию или после нажатия кнопки "Готово" (`applyChanges()`)

### Состояние данных

Компонент автоматически нормализует данные при инициализации:

- **Нормализация `childrenAges`:** Автоматически синхронизирует массив возрастов с количеством детей
- **Валидация значений:** Все значения автоматически ограничиваются допустимыми диапазонами
- **Обработка legacy формата:** Автоматически конвертирует старый формат в новый

### Состояние применения изменений

Изменения применяются только после нажатия кнопки "Готово":

- Пользователь может изменять значения в выпадающем меню
- Изменения не применяются к `modelValue` до нажатия "Готово"
- При нажатии "Готово" эмитится событие `update:modelValue` и меню закрывается

## Валидация

Компонент выполняет автоматическую валидацию всех значений:

### Валидация количества номеров

- **Минимум:** 1 номер (нельзя удалить последний номер)
- **Максимум:** 5 номеров (`MAX_ROOMS`)
- **Поведение:** Значения автоматически ограничиваются диапазоном 1-5

### Валидация количества взрослых

- **Минимум:** 1 взрослый в каждом номере
- **Поведение:** При попытке установить значение меньше 1, автоматически устанавливается 1

### Валидация количества детей

- **Минимум:** 0 детей в каждом номере
- **Поведение:** При попытке установить отрицательное значение, автоматически устанавливается 0

### Валидация возраста детей

- **Минимум:** `AGE_MIN` (0 лет)
- **Максимум:** `AGE_MAX` (12 лет)
- **Поведение:** Возраст автоматически ограничивается диапазоном 0-12

### Нормализация данных

Компонент автоматически нормализует данные при инициализации:

1. **Синхронизация `childrenAges` с количеством детей:**
   - Если возрастов меньше, недостающие заполняются `AGE_MIN`
   - Если возрастов больше, лишние обрезаются
   - Если `childrenAges` отсутствует, создается массив с `AGE_MIN`

2. **Обработка некорректных данных:**
   - Если `modelValue` не передан или некорректен, устанавливаются дефолтные значения
   - Если передан legacy формат, данные конвертируются в новый формат

## Логика работы с форматами данных

### Новый формат (рекомендуемый)

```typescript
{
  rooms: 2,
  roomList: [
    { adults: 2, children: 1, childrenAges: [5] },
    { adults: 1, children: 0, childrenAges: [] }
  ]
}
```

**Преимущества:**
- Позволяет задавать разные значения для каждого номера
- Более гибкий и расширяемый формат
- Прямое соответствие между количеством номеров и данными

### Legacy формат (для обратной совместимости)

```typescript
{
  rooms: 2,
  adults: 3,
  children: 2
}
```

**Особенности:**
- Значения `adults` и `children` применяются только к первому номеру
- Остальные номера инициализируются с дефолтными значениями
- Автоматически конвертируется в новый формат при обработке

**Рекомендация:** Используйте новый формат для новых компонентов и постепенно мигрируйте существующий код.

## Зависимости от других компонентов

### CoreCounter

Компонент счетчика для изменения числовых значений.

**Используется для:**
- Выбора количества номеров (1-5)
- Выбора количества взрослых в каждом номере (минимум 1)
- Выбора количества детей в каждом номере (минимум 0)

**Props:**
- `model-value` - текущее значение
- `min` - минимальное значение
- `max` - максимальное значение (только для номеров)

**Events:**
- `@update:model-value` - событие изменения значения

### CoreRoomBlock

Компонент блока номера для отображения и редактирования данных по каждому номеру.

**Используется для:**
- Отображения информации о каждом номере
- Редактирования количества взрослых и детей
- Выбора возраста каждого ребенка
- Удаления номера (если номеров > 1)

**Props:**
- `room` - данные о гостях в номере (`RoomGuests`)
- `room-index` - индекс номера (0-based)
- `total-rooms` - общее количество номеров

**Events:**
- `@update:adults` - изменение количества взрослых
- `@update:children` - изменение количества детей
- `@update:child-age` - изменение возраста ребенка
- `@delete` - удаление номера

### Popover (PrimeVue)

Компонент выпадающего меню для отображения формы выбора гостей.

**Используется для:**
- Отображения формы выбора гостей в выпадающем меню
- Управления открытием/закрытием меню

**Методы:**
- `toggle(event)` - переключение состояния меню
- `hide(event)` - закрытие меню

## Примеры использования

### Полный пример формы бронирования

```vue
<template>
  <div class="booking-form">
    <CoreGuestsSelector v-model="bookingData.guests" />
    <button @click="submitBooking">Забронировать</button>
  </div>
</template>

<script setup lang="ts">
import type { RoomGuests } from '~/components/core/GuestsSelector.vue';

interface BookingData {
  guests: {
    rooms: number;
    roomList: RoomGuests[];
  };
}

const bookingData = ref<BookingData>({
  guests: {
    rooms: 1,
    roomList: [{ adults: 2, children: 0, childrenAges: [] }]
  }
});

function submitBooking() {
  console.log('Бронирование:', bookingData.value.guests);
}
</script>
```

### Пример с валидацией

```vue
<template>
  <div>
    <CoreGuestsSelector v-model="guests" />
    <div v-if="!isValid" class="error">
      Минимум 1 взрослый в каждом номере
    </div>
  </div>
</template>

<script setup lang="ts">
const guests = ref({
  rooms: 2,
  roomList: [
    { adults: 2, children: 1, childrenAges: [5] },
    { adults: 1, children: 0, childrenAges: [] }
  ]
});

const isValid = computed(() => {
  return guests.value.roomList.every(room => room.adults >= 1);
});
</script>
```

### Пример с обработкой изменений

```vue
<template>
  <CoreGuestsSelector
    v-model="guests"
    @update:model-value="handleGuestsChange"
  />
</template>

<script setup lang="ts">
const guests = ref({
  rooms: 1,
  roomList: [{ adults: 1, children: 0, childrenAges: [] }]
});

function handleGuestsChange(newValue: GuestsValue) {
  console.log('Гости изменены:', newValue);
  // Дополнительная логика обработки
}
</script>
```

## Примечания

- Компонент использует `v-model` для двусторонней привязки данных
- Все изменения применяются только после нажатия кнопки "Готово"
- Компонент автоматически нормализует данные при инициализации
- Интерфейс `RoomGuests` экспортируется и может быть использован в других компонентах
- Компонент поддерживает обратную совместимость с legacy форматом данных
- Все значения автоматически валидируются и ограничиваются допустимыми диапазонами
- Компонент адаптивен и поддерживает различные разрешения экрана
- Компонент покрыт комплексными тестами (32 теста)

## Тестирование

Компонент покрыт комплексными тестами, проверяющими:

- ✅ Инициализацию с различными форматами данных (новый формат, legacy формат, дефолтные значения)
- ✅ Нормализацию `childrenAges` при несоответствии количества детей
- ✅ Обновление количества номеров (увеличение, уменьшение, ограничения)
- ✅ Удаление номеров (с проверкой минимального количества)
- ✅ Обновление количества взрослых (с валидацией минимума)
- ✅ Обновление количества детей (с сохранением/обрезанием возрастов)
- ✅ Обновление возраста детей (с валидацией диапазона)
- ✅ Формирование `summaryString` для различных сценариев
- ✅ Работу с overlay (открытие, закрытие, применение изменений)
- ✅ Рендеринг компонента (input, label, счетчики, блоки номеров, кнопка)
- ✅ Интеграцию с дочерними компонентами (CoreCounter, CoreRoomBlock)

**Расположение тестов:** `tests/components/core/GuestsSelector.spec.ts`

## Связанные компоненты

- `CoreCounter` - счетчик для изменения числовых значений
- `CoreRoomBlock` - блок номера для редактирования данных о гостях
- `CoreDatePicker` - компонент выбора дат (часто используется вместе с GuestsSelector)
- `Booking` - форма бронирования, использующая GuestsSelector

## Связанные утилиты

- `~/utils/age` - константы и функции для работы с возрастом детей
- `~/utils/declension` - функция склонения слов для русского языка

## Константы

- `MAX_ROOMS = 5` - максимальное количество номеров
- `AGE_MIN = 0` - минимальный возраст ребенка (из `~/utils/age`)
- `AGE_MAX = 12` - максимальный возраст ребенка (из `~/utils/age`)

