# Card.vue

## Описание

Компонент `Card.vue` представляет собой карточку номера в системе бронирования. Компонент отображает информацию о номере (фотографии, характеристики, цены), позволяет выбрать тип кровати и перейти к выбору тарифа. Компонент поддерживает работу с вариантами номеров (room_type_codes) и автоматически выбирает подходящий вариант на основе доступных типов кроватей.

## Расположение

```
app/components/booking/Card.vue
```

## Зависимости

### Props

- **`room`** (`Room`) - объект номера с информацией о характеристиках, фотографиях, ценах и вариантах

### Stores

- **`useBookingStore`** (`~/stores/booking`) - хранилище состояния бронирования
  - Используемые свойства:
    - `date` - выбранные даты заезда/выезда (`[Date, Date] | null`)
    - `guests` - информация о гостях (количество комнат и список комнат с количеством взрослых и детей)
  - Используемые методы:
    - `setSelectedRoomType(roomTypeCode: string)` - установка выбранного типа номера

### Composables

- **`useRouter()`** - для программной навигации
- **`storeToRefs()`** - для создания реактивных ссылок на свойства store
- **`useRoomCarousel()`** (`~/composables/useRoomCarousel`) - для подготовки изображений карусели с плейсхолдерами
- **`useNights()`** (`~/composables/useNights`) - для вычисления количества ночей между датами

### Компоненты

- **`BookingCarousel`** - компонент карусели для отображения фотографий номера
- **`BookingRoomPopup`** - модальное окно с подробной информацией о номере
- **`Select`** - компонент выбора типа кровати (PrimeVue)
- **`Button`** - кнопка перехода к выбору тарифа (PrimeVue)
- **`ProgressSpinner`** - индикатор загрузки (PrimeVue)
- **`UIcon`** - компонент иконок из Nuxt UI

### Типы

- **`Room`** (`~/types/room`) - интерфейс номера
  ```typescript
  interface Room {
    id?: string | number;
    room_type_code: string;
    title: string;
    description: string | null;
    max_occupancy: number;
    square: number;
    rooms: number;
    amenities: RoomAmenity[];
    bed?: RoomBed | null;
    view?: RoomView | null;
    family?: RoomFamily | null;
    min_price: number;
    price_for_register?: number;
    photos: string[];
    tariffs: RoomTariff[];
    group_title?: string;
    group_description?: string | null;
    room_type_codes?: Room[]; // Варианты номера с разными типами кроватей
  }
  ```

### Утилиты

- **`formatCount`** (`~/utils/declension`) - функция для форматирования чисел с правильным склонением слов

## Структура компонента

### Script Setup

Компонент использует Composition API с `<script setup>`.

#### Константы

- `CAROUSEL_MIN_PHOTOS = 2` - минимальное количество фотографий перед добавлением плейсхолдеров
- `CAROUSEL_TARGET_ITEMS = 3` - целевое количество элементов в карусели
- `CAROUSEL_PLACEHOLDER_LABEL = "Room Photo"` - метка для плейсхолдеров

#### Реактивные данные

- `loading` - состояние загрузки при переходе к выбору тарифа
- `isPopupOpen` - состояние открытия модального окна с подробной информацией
- `selectedBedType` - выбранный тип кровати (room_type_code)

#### Computed свойства

##### `isValidDateRange: boolean`

Проверяет валидность выбранного диапазона дат.

**Возвращает:**
- `true` - если выбраны обе даты (заезд и выезд)
- `false` - если даты не выбраны или неполные

##### `totalAdults: number`

Вычисляет общее количество взрослых гостей из всех комнат.

**Алгоритм:**
- Если `guests.value?.roomList` отсутствует, возвращает `0`
- Иначе суммирует `adults` из всех комнат в `roomList`

##### `availableRoomVariants: Room[]`

Возвращает доступные варианты номера.

**Алгоритм:**
- Если у номера есть `room_type_codes` (массив вариантов), возвращает их
- Иначе возвращает массив с одним элементом - исходным номером

##### `bedOptions: { id: string; title: string }[]`

Формирует список опций для выбора типа кровати.

**Алгоритм:**
1. Проходит по всем вариантам номера
2. Извлекает уникальные типы кроватей (по `bed.title`)
3. Возвращает массив объектов с `id` (room_type_code) и `title` (bed.title)

**Особенности:**
- Исключает дубликаты по названию кровати
- Использует `Set` для отслеживания уже добавленных названий
- Пропускает варианты без кровати или с пустым названием

##### `currentRoom: Room`

Определяет текущий отображаемый вариант номера.

**Алгоритм выбора:**
1. Если выбран тип кровати (`selectedBedType`), ищет вариант с соответствующим `room_type_code`
2. Если не найден, ищет любой вариант с кроватью (`bed?.title`)
3. Если не найден, возвращает первый вариант из списка
4. Если вариантов нет, возвращает исходный номер из props

##### `nightsCount: number`

Вычисляет количество ночей между датами заезда и выезда через composable `useNights()`.

##### `carouselImages: (string | { placeholder: true; label?: string })[]`

Подготавливает изображения для карусели через composable `useRoomCarousel()`.

**Особенности:**
- Если фотографий меньше `CAROUSEL_MIN_PHOTOS`, добавляет плейсхолдеры
- Целевое количество элементов - `CAROUSEL_TARGET_ITEMS`

#### Методы

##### `openPopup(event: MouseEvent): void`

Открывает модальное окно с подробной информацией о номере.

**Параметры:**
- `event` - событие клика мыши

**Действия:**
- Останавливает всплытие события (`stopPropagation()`)
- Устанавливает `isPopupOpen.value = true`

##### `closePopup(): void`

Закрывает модальное окно с подробной информацией.

**Действия:**
- Устанавливает `isPopupOpen.value = false`

##### `findVariantByCode(variants: Room[], code: string | null): Room | null`

Ищет вариант номера по коду типа.

**Параметры:**
- `variants` - массив вариантов номеров
- `code` - код типа номера для поиска

**Возвращает:**
- Найденный вариант или `null`

##### `findVariantWithBed(variants: Room[]): Room | null`

Ищет первый вариант номера с указанным типом кровати.

**Параметры:**
- `variants` - массив вариантов номеров

**Возвращает:**
- Вариант с кроватью или `null`

##### `handleTariff(): Promise<void>`

Асинхронный метод обработки перехода к выбору тарифа.

**Алгоритм работы:**

1. **Валидация дат** - проверяет `isValidDateRange.value`, при неудаче выводит ошибку в консоль и прерывает выполнение
2. **Установка состояния загрузки** - устанавливает `loading.value = true`
3. **Сохранение выбранного типа номера** - вызывает `bookingStore.setSelectedRoomType()` с `room_type_code` текущего номера
4. **Определение количества комнат:**
   - Если есть `bookingStore.guests?.roomList`, берет его длину
   - Иначе берет `bookingStore.guests?.rooms` или `1`
5. **Определение целевого маршрута:**
   - Если комнат > 1 → `/multi-rooms`
   - Иначе → `/rooms/tariff`
6. **Навигация** - переходит на целевой маршрут через `router.push()`
7. **Сброс состояния** - в блоке `finally` устанавливает `loading.value = false`

**Обработка ошибок:**
- Ошибки навигации обрабатываются в блоке `finally`, состояние загрузки всегда сбрасывается

#### Watchers

##### `watch(availableRoomVariants, ...)`

Отслеживает изменения доступных вариантов номера и автоматически выбирает подходящий тип кровати.

**Алгоритм выбора fallback значения:**

1. **Приоритет 1:** Вариант с кодом из `props.room.room_type_code`, у которого есть кровать
2. **Приоритет 2:** Любой вариант с кроватью
3. **Приоритет 3:** Первый вариант из списка

**Логика обновления `selectedBedType`:**
- Если текущий выбранный тип отсутствует в новых вариантах, устанавливается fallback значение
- Если fallback не найден, устанавливается `null`

**Опции:**
- `immediate: true` - выполняется сразу при инициализации компонента

### Template

Компонент рендерит карточку номера со следующей структурой:

```vue
<article :class="$style.card">
  <!-- Карусель с фотографиями -->
  <header :class="$style.carouselWrapper">
    <BookingCarousel ... />
  </header>

  <!-- Основная информация -->
  <div :class="$style.cardDetails">
    <div :class="$style.wrapperInfoBlock">
      <!-- Заголовок и кнопка подробностей -->
      <div :class="$style.roomInfo">
        <h2>{{ currentRoom.title }}</h2>
        <button @click="openPopup">...</button>
      </div>

      <!-- Характеристики номера -->
      <dl :class="$style.description">
        <!-- Максимальная вместимость -->
        <!-- Площадь -->
        <!-- Количество комнат -->
      </dl>

      <!-- Блок с ценами -->
      <div :class="$style.priceBlock">
        <!-- Цена за регистрацию -->
        <!-- Минимальная цена -->
        <!-- Информация о гостях и ночах -->
      </div>
    </div>

    <!-- Футер с выбором кровати и кнопкой -->
    <footer :class="$style.footer">
      <!-- Выбор типа кровати -->
      <div :class="$style.bedSelect">
        <Select v-model="selectedBedType" ... />
      </div>

      <!-- Кнопка выбора номера -->
      <Button @click="handleTariff" ...>
        <span>Выбрать номер</span>
        <ProgressSpinner v-show="loading" ... />
      </Button>
    </footer>
  </div>

  <!-- Модальное окно с подробной информацией -->
  <BookingRoomPopup ... />
</article>
```

**Структура:**

- `article.card` - основная обертка карточки
- `header.carouselWrapper` - обертка карусели с фотографиями
- `div.cardDetails` - контейнер с деталями номера
- `div.wrapperInfoBlock` - блок с основной информацией
- `div.roomInfo` - заголовок и кнопка подробностей
- `dl.description` - список характеристик (вместимость, площадь, комнаты)
- `div.priceBlock` - блок с ценами и информацией о бронировании
- `footer.footer` - футер с выбором кровати и кнопкой
- `div.bedSelect` - выбор типа кровати
- `BookingRoomPopup` - модальное окно с подробной информацией

**Отображаемая информация:**

1. **Фотографии:** Карусель с фотографиями номера (с плейсхолдерами при необходимости)
2. **Название:** `currentRoom.title`
3. **Вместимость:** "До {количество} {склонение 'гостя'}"
4. **Площадь:** "{количество} м²"
5. **Комнаты:** "{количество} {склонение 'комната'}"
6. **Цена за регистрацию:** "За регистрацию {цена} ₽"
7. **Минимальная цена:** "От {цена} руб."
8. **Информация о бронировании:** "{количество гостей} / {количество ночей}"

**Интерактивные элементы:**

- Кнопка с иконкой шеврона - открывает модальное окно с подробной информацией
- Select для выбора типа кровати - фильтрует варианты номера
- Кнопка "Выбрать номер" - переходит к выбору тарифа (отключена при отсутствии дат или загрузке)

**Примечание:** Компонент использует CSS Modules (`<style module>`) с SCSS. Подробнее о системе стилей проекта см. в [общей документации](../README.md#стили).

## Использование

### Базовое использование

Компонент требует обязательный prop `room`:

```vue
<template>
  <BookingCard :room="roomData" />
</template>

<script setup lang="ts">
import type { Room } from "~/types/room";

const roomData: Room = {
  room_type_code: "standard",
  title: "Стандартный номер",
  // ... остальные свойства
};
</script>
```

### Использование в списке номеров

Компонент обычно используется в цикле для отображения списка доступных номеров:

```vue
<template>
  <div class="rooms-list">
    <BookingCard
      v-for="room in rooms"
      :key="room.room_type_code"
      :room="room"
    />
  </div>
</template>

<script setup lang="ts">
import type { Room } from "~/types/room";

const rooms = ref<Room[]>([]);
// ... загрузка номеров
</script>
```

## Состояния компонента

### Состояние загрузки

Компонент отображает состояние загрузки при переходе к выбору тарифа:

- Кнопка "Выбрать номер" становится неактивной (`disabled`)
- Отображается индикатор загрузки (`ProgressSpinner`) внутри кнопки
- Кнопка получает класс `loading` (меняет цвет фона)

### Состояние валидности дат

Кнопка "Выбрать номер" отключена, если:
- Не выбраны даты заезда/выезда (`!isValidDateRange`)
- Идет загрузка (`loading === true`)

### Состояние модального окна

Модальное окно с подробной информацией управляется через:
- `isPopupOpen` - реактивное состояние
- `openPopup()` - открытие окна
- `closePopup()` - закрытие окна

## Логика работы с вариантами номеров

Компонент поддерживает работу с вариантами номеров (разные типы кроватей для одного номера).

### Автоматический выбор варианта

При инициализации и изменении вариантов компонент автоматически выбирает подходящий вариант:

1. **Приоритет 1:** Вариант с кодом из props, у которого есть кровать
2. **Приоритет 2:** Любой вариант с кроватью
3. **Приоритет 3:** Первый доступный вариант

### Выбор типа кровати

Пользователь может выбрать тип кровати через компонент `Select`:
- Опции формируются из уникальных типов кроватей всех вариантов
- При выборе обновляется `currentRoom` - отображаемый вариант номера
- Все данные (цены, фотографии, характеристики) обновляются в соответствии с выбранным вариантом

### Обработка отсутствия вариантов

Если у номера нет вариантов (`room_type_codes` отсутствует или пуст):
- Используется исходный номер из props
- Select для выбора кровати не отображается (если нет опций)
- Компонент работает как обычная карточка без выбора вариантов

## Навигация

При нажатии на кнопку "Выбрать номер" компонент:

1. Сохраняет выбранный тип номера в store через `setSelectedRoomType()`
2. Определяет целевой маршрут на основе количества комнат:
   - **Одна комната:** `/rooms/tariff`
   - **Несколько комнат:** `/multi-rooms`
3. Выполняет навигацию через `router.push()`

**Важно:** Навигация происходит только при валидных датах бронирования.

## Валидация

Компонент выполняет валидацию перед переходом к выбору тарифа:

1. **Проверка дат:** Обязательно наличие выбранных дат заезда/выезда
   - При отсутствии дат выводится ошибка в консоль
   - Навигация не выполняется

**Примечание:** Валидация количества гостей не выполняется на уровне компонента, так как эта информация используется только для отображения.

## Логирование

При отсутствии выбранных дат компонент выводит ошибку в консоль:

```javascript
console.error("Не выбраны даты бронирования");
```

## Зависимости от других компонентов

### BookingCarousel

Компонент карусели для отображения фотографий номера.

**Props:**
- `images` - массив изображений или плейсхолдеров
- `alt-prefix` - префикс для alt-текста
- `alt-text` - основной текст для alt-атрибута
- `height` - высота карусели

### BookingRoomPopup

Модальное окно с подробной информацией о номере.

**Props:**
- `room` - объект номера для отображения
- `is-open` - состояние открытия/закрытия

**Events:**
- `@close` - событие закрытия окна

### Select (PrimeVue)

Компонент выбора типа кровати.

**Props:**
- `v-model` - выбранное значение (room_type_code)
- `options` - массив опций для выбора
- `option-label` - поле для отображения (`title`)
- `option-value` - поле для значения (`id`)
- `placeholder` - текст плейсхолдера

## Примеры использования

### Полный пример страницы с карточками номеров

```vue
<script setup lang="ts">
import type { Room } from "~/types/room";

const bookingStore = useBookingStore();
const { searchResults } = storeToRefs(bookingStore);

const rooms = computed<Room[]>(() => {
  return searchResults.value?.rooms || [];
});
</script>

<template>
  <div class="rooms-page">
    <h1>Доступные номера</h1>
    <div class="rooms-grid">
      <BookingCard
        v-for="room in rooms"
        :key="room.room_type_code"
        :room="room"
      />
    </div>
  </div>
</template>
```

### Пример с обработкой загрузки

```vue
<template>
  <div v-if="loading">Загрузка номеров...</div>
  <div v-else class="rooms-list">
    <BookingCard
      v-for="room in rooms"
      :key="room.room_type_code"
      :room="room"
    />
  </div>
</template>
```

## Примечания

- Компонент использует глобальное состояние через Pinia store (`bookingStore`)
- Данные о датах и гостях синхронизируются с `bookingStore`
- Компонент автоматически определяет целевой маршрут на основе количества комнат
- Поддерживается работа с вариантами номеров (разные типы кроватей)
- Автоматический выбор подходящего варианта при инициализации
- Карусель автоматически добавляет плейсхолдеры при недостаточном количестве фотографий
- Все текстовые значения (количество гостей, ночей, комнат) правильно склоняются через `formatCount()`

## Связанные компоненты

- `BookingCarousel` - карусель фотографий
- `BookingRoomPopup` - модальное окно с подробной информацией
- `MultiCard` - карточка для бронирования нескольких номеров

## Связанные страницы

- `/rooms` - страница результатов поиска для одного номера
- `/rooms/tariff` - страница выбора тарифа для одного номера
- `/multi-rooms` - страница результатов поиска для нескольких номеров

## Связанные composables

- `useRoomCarousel` - подготовка изображений для карусели
- `useNights` - вычисление количества ночей
- `useBookingStore` - управление состоянием бронирования

